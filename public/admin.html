<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>لوحة الإدارة - Meshari Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-900 text-white min-h-screen">
    <!-- HEADER -->
    <header class="bg-slate-800 px-6 py-4 flex justify-between items-center shadow">
      <h1 class="text-xl font-bold">لوحة الإدارة</h1>

      <div class="flex items-center gap-4">
        <span id="adminName" class="text-slate-300"></span>

        <button
          id="logoutBtn"
          class="bg-rose-500 hover:bg-rose-600 px-3 py-1 rounded-lg text-sm"
        >
          تسجيل الخروج
        </button>

        <a
          href="index.html"
          class="px-3 py-1 rounded-lg bg-slate-700 text-sm hover:bg-slate-600"
        >
          المتجر
        </a>
      </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-5xl mx-auto py-10 space-y-10 px-4">

      <!-- إضافة منتج -->
      <section class="bg-slate-800 rounded-2xl p-6 shadow-lg">
        <h2 class="text-lg font-semibold mb-4">إضافة منتج جديد</h2>

        <form id="addProductForm" class="grid md:grid-cols-2 gap-4">

          <!-- اسم المنتج -->
          <div>
            <label class="block mb-1 text-sm">اسم المنتج</label>
            <input
              name="name"
              required
              class="w-full bg-slate-700 rounded-lg p-2 border border-slate-600"
            />
          </div>

          <!-- السعر -->
          <div>
            <label class="block mb-1 text-sm">السعر (ر.س)</label>
            <input
              name="price"
              type="number"
              required
              class="w-full bg-slate-700 rounded-lg p-2 border border-slate-600"
            />
          </div>

          <!-- القسم -->
          <div>
            <label class="block mb-1 text-sm">القسم/الفئة</label>
            <input
              name="category"
              required
              class="w-full bg-slate-700 rounded-lg p-2 border border-slate-600"
            />
          </div>

          <!-- رفع صورة -->
          <div>
            <label class="block mb-1 text-sm">صورة المنتج</label>

            <input
              id="productImage"
              type="file"
              accept="image/*"
              class="w-full bg-slate-700 rounded-lg p-2 border border-slate-600"
            />

            <img
              id="previewImg"
              class="hidden mt-3 w-full h-40 rounded-lg object-cover border border-slate-600"
            />
          </div>

          <!-- الوصف -->
          <div class="md:col-span-2">
            <label class="block mb-1 text-sm">الوصف</label>
            <textarea
              name="description"
              rows="3"
              class="w-full bg-slate-700 rounded-lg p-2 border border-slate-600"
            ></textarea>
          </div>

          <p id="formMsg" class="md:col-span-2 text-sm"></p>

          <div class="md:col-span-2 flex justify-end">
            <button
              class="bg-indigo-500 hover:bg-indigo-600 px-6 py-2 rounded-lg font-semibold"
            >
              إضافة المنتج
            </button>
          </div>
        </form>
      </section>

      <!-- قائمة المنتجات -->
      <section class="bg-slate-800 rounded-2xl p-6 shadow-lg">
        <h2 class="text-lg font-semibold mb-4">المنتجات الحالية</h2>
        <div id="adminProductsList" class="space-y-3"></div>
      </section>

      <!-- المستخدمين -->
      <section class="bg-slate-800 rounded-2xl p-6 shadow-lg">
        <h2 class="text-lg font-semibold mb-4">المستخدمون المسجلون</h2>
        <div id="usersList" class="space-y-3"></div>
      </section>

    </main>

    <!-- SCRIPTS -->
    <script>
      const API_BASE = "";

      /* -------- Current User -------- */
      function getCurrentUser() {
        try {
          return JSON.parse(localStorage.getItem("currentUser")) || null;
        } catch {
          return null;
        }
      }

      function requireAdmin() {
        const user = getCurrentUser();
        if (!user || user.role !== "admin") {
          window.location.href = "login.html";
        }
        return user;
      }

      function setupHeader(user) {
        if (!user) return;

        const nameSpan = document.getElementById("adminName");
        nameSpan.textContent = "مرحباً، " + user.name + " (أدمن)";

        document.getElementById("logoutBtn").onclick = () => {
          localStorage.removeItem("currentUser");
          window.location.href = "login.html";
        };
      }

      /* -------- رفع الصورة -------- */
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("productImage").onchange = function () {
          const img = document.getElementById("previewImg");
          img.src = URL.createObjectURL(this.files[0]);
          img.classList.remove("hidden");
        };
      });

      /* -------- تحميل المنتجات -------- */
      async function loadProducts() {
        const box = document.getElementById("adminProductsList");
        box.innerHTML = "";

        const res = await fetch(`${API_BASE}/api/products`);
        const data = await res.json();

        if (!data.length) {
          box.innerHTML = `<p class="text-slate-400">لا يوجد منتجات</p>`;
          return;
        }

        data.forEach((p) => {
          box.innerHTML += `
            <div class="bg-slate-700 p-3 rounded-lg flex justify-between">
              <div>
                <div class="font-bold">${p.name}</div>
                <div class="text-slate-300">${p.price} ر.س – ${p.category}</div>
              </div>
              <span class="text-xs text-slate-400">ID: ${p.id}</span>
            </div>
          `;
        });
      }

      /* -------- تحميل المستخدمين -------- */
      async function loadUsers() {
        const box = document.getElementById("usersList");
        box.innerHTML = "";

        const res = await fetch(`${API_BASE}/api/users`);
        const users = await res.json();

        users.forEach((u) => {
          box.innerHTML += `
            <div class="bg-slate-700 p-3 rounded-lg flex justify-between">
              <div>
                <div class="font-bold">${u.name}</div>
                <div class="text-slate-300">${u.email}</div>
              </div>
              <span class="text-xs text-slate-400">Role: ${u.role}</span>
            </div>
          `;
        });
      }

      /* -------- إرسال المنتج -------- */
      function setupAddForm() {
        const form = document.getElementById("addProductForm");
        const msg = document.getElementById("formMsg");

        form.onsubmit = async (e) => {
          e.preventDefault();

          const data = new FormData(form);

          const body = {
            name: data.get("name"),
            price: data.get("price"),
            category: data.get("category"),
            description: data.get("description"),
            image: document.getElementById("productImage").value.replace("C:\\\\fakepath\\\\", "")
          };

          const res = await fetch(`${API_BASE}/api/products`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
          });

          const result = await res.json();

          if (result.success) {
            msg.textContent = "✔ تمت إضافة المنتج بنجاح";
            msg.className = "text-emerald-400";
            form.reset();
            loadProducts();
            document.getElementById("previewImg").classList.add("hidden");
          } else {
            msg.textContent = "حدث خطأ";
            msg.className = "text-rose-400";
          }
        };
      }

      /* -------- تشغيل كل شيء -------- */
      document.addEventListener("DOMContentLoaded", () => {
        const user = requireAdmin();
        setupHeader(user);

        setupAddForm();
        loadProducts();
        loadUsers();
      });
    </script>
  </body>
</html>