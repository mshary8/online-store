<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة الإدارة - المتجر</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-900 text-white">
  <header class="bg-slate-800 px-6 py-4 flex items-center justify-between">
    <h1 class="text-xl font-bold">لوحة الإدارة</h1>
    <div class="flex items-center gap-4">
      <span id="adminName" class="text-sm text-slate-300"></span>
      <button id="logoutBtn" class="px-3 py-1 rounded-lg bg-rose-500 hover:bg-rose-600 text-sm">
        تسجيل الخروج
      </button>
      <a href="/" class="px-3 py-1 rounded-lg bg-slate-700 text-sm">العودة للمتجر</a>
    </div>
  </header>

  <main class="max-w-5xl mx-auto py-8 px-4 space-y-8">
    <!-- إضافة منتج -->
    <section class="bg-slate-800 rounded-2xl p-6 shadow">
      <h2 class="text-lg font-semibold mb-4">إضافة منتج جديد</h2>
      <form id="productForm" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block mb-1 text-sm">اسم المنتج</label>
          <input id="name" class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600" required />
        </div>
        <div>
          <label class="block mb-1 text-sm">السعر (ر.س)</label>
          <input id="price" type="number" step="0.01" class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600" required />
        </div>
        <div>
          <label class="block mb-1 text-sm">القسم / الفئة</label>
          <input id="category" class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600" />
        </div>
        <div>
          <label class="block mb-1 text-sm">اسم الصورة (مثال: shoes.jpg)</label>
          <input id="image" class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600" />
        </div>
        <div class="md:col-span-2">
          <label class="block mb-1 text-sm">الوصف</label>
          <textarea id="description" rows="3" class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600"></textarea>
        </div>
        <p id="formMsg" class="text-sm text-emerald-400 md:col-span-2"></p>
        <div class="md:col-span-2 flex justify-end">
          <button class="px-5 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 font-semibold">
            إضافة المنتج
          </button>
        </div>
      </form>
    </section>

    <!-- قائمة المنتجات -->
    <section class="bg-slate-800 rounded-2xl p-6 shadow">
      <h2 class="text-lg font-semibold mb-4">المنتجات الحالية</h2>
      <div id="productsList" class="space-y-3"></div>
    </section>
  </main>

  <script>
    async function fetchMe() {
      const res = await fetch("/api/auth/me");
      const data = await res.json();
      if (!data.user || data.user.role !== "admin") {
        window.location.href = "/login.html";
        return;
      }
      document.getElementById("adminName").textContent =
        "مرحبًا، " + data.user.username;
    }

    async function loadProducts() {
      const res = await fetch("/api/admin/products");
      if (!res.ok) return;
      const products = await res.json();
      const container = document.getElementById("productsList");
      container.innerHTML = "";

      if (products.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-400">لا يوجد منتجات.</p>';
        return;
      }

      products.forEach((p) => {
        const div = document.createElement("div");
        div.className =
          "flex items-center justify-between bg-slate-700 rounded-xl px-4 py-3 text-sm";
        div.innerHTML = `
          <div>
            <div class="font-semibold">${p.name}</div>
            <div class="text-slate-300">${p.price} ر.س - ${p.category || ""}</div>
          </div>
          <button data-id="${p.id}" class="deleteBtn px-3 py-1 rounded-lg bg-rose-500 hover:bg-rose-600 text-xs">
            حذف
          </button>
        `;
        container.appendChild(div);
      });

      // أزرار الحذف
      document.querySelectorAll(".deleteBtn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("هل أنت متأكد من الحذف؟")) return;

          const res = await fetch("/api/admin/products/" + id, {
            method: "DELETE",
          });
          if (res.ok) {
            loadProducts();
          }
        });
      });
    }

    document
      .getElementById("productForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const formMsg = document.getElementById("formMsg");
        formMsg.textContent = "";

        const body = {
          name: document.getElementById("name").value,
          price: document.getElementById("price").value,
          category: document.getElementById("category").value,
          image: document.getElementById("image").value,
          description: document.getElementById("description").value,
        };

        const res = await fetch("/api/admin/products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const data = await res.json();
        if (!res.ok) {
          formMsg.textContent = data.message || "حدث خطأ";
          formMsg.className = "text-sm text-rose-400";
          return;
        }

        formMsg.textContent = "تم إضافة المنتج بنجاح ✅";
        formMsg.className = "text-sm text-emerald-400";

        e.target.reset();
        loadProducts();
      });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("/api/auth/logout", { method: "POST" });
      window.location.href = "/login.html";
    });

    // عند فتح الصفحة
    fetchMe().then(loadProducts);
  </script>
</body>
</html>