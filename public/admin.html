<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>لوحة الإدارة - المتجر</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-900 text-white">
    <header class="bg-slate-800 px-6 py-4 flex items-center justify-between">
      <h1 class="text-xl font-bold">لوحة الإدارة</h1>
      <div class="flex items-center gap-4">
        <span id="adminName" class="text-sm text-slate-300"></span>
        <button
          id="logoutBtn"
          class="px-3 py-1 rounded-lg bg-rose-500 hover:bg-rose-600 text-sm"
        >
          تسجيل الخروج
        </button>
        <a
          href="index.html"
          class="px-3 py-1 rounded-lg bg-slate-700 text-sm"
          >العودة للمتجر</a
        >
      </div>
    </header>

    <main class="max-w-6xl mx-auto py-8 px-4 space-y-8">
      <!-- إضافة منتج -->
      <section class="bg-slate-800 rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold mb-4">إضافة منتج جديد</h2>
        <form id="addProductForm" class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 text-sm">اسم المنتج</label>
            <input
              name="name"
              class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600"
              required
            />
          </div>
          <div>
            <label class="block mb-1 text-sm">السعر (ر.س)</label>
            <input
              name="price"
              type="number"
              step="0.01"
              class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600"
              required
            />
          </div>
          <div>
            <label class="block mb-1 text-sm">القسم / الفئة</label>
            <input
              name="category"
              class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600"
              required
            />
          </div>
          <div>
            <label class="block mb-1 text-sm"
              >اسم الصورة (مثال: shoes.jpg)</label
            >
            <input
              name="image"
              class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600"
              required
            />
          </div>
          <div class="md:col-span-2">
            <label class="block mb-1 text-sm">الوصف</label>
            <textarea
              name="description"
              rows="3"
              class="w-full rounded-lg px-3 py-2 bg-slate-700 border border-slate-600"
            ></textarea>
          </div>
          <p id="formMsg" class="text-sm md:col-span-2"></p>
          <div class="md:col-span-2 flex justify-end">
            <button
              class="px-5 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 font-semibold"
            >
              إضافة المنتج
            </button>
          </div>
        </form>
      </section>

      <!-- قائمة المنتجات -->
      <section class="bg-slate-800 rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold mb-4">المنتجات الحالية</h2>
        <div id="adminProductsList" class="space-y-3"></div>
      </section>

      <!-- المستخدمون -->
      <section class="bg-slate-800 rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold mb-4">المستخدمون المسجّلون</h2>
        <div id="usersList" class="space-y-2 text-sm"></div>
      </section>
    </main>

    <script>
      const API_BASE = "";

      function getCurrentUser() {
        try {
          const raw = localStorage.getItem("currentUser");
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          return null;
        }
      }

      function requireAdmin() {
        const user = getCurrentUser();
        if (!user || user.role !== "admin") {
          window.location.href = "login.html";
          return null;
        }
        return user;
      }

      function setupHeader(user) {
        const nameSpan = document.getElementById("adminName");
        const logoutBtn = document.getElementById("logoutBtn");

        if (user && nameSpan) {
          nameSpan.textContent = "مرحباً، " + user.name + " (أدمن)";
        }

        if (logoutBtn) {
          logoutBtn.onclick = () => {
            localStorage.removeItem("currentUser");
            window.location.href = "login.html";
          };
        }
      }

      async function loadProducts() {
        const container = document.getElementById("adminProductsList");
        if (!container) return;

        try {
          const res = await fetch(`${API_BASE}/api/products`);
          const products = await res.json();

          container.innerHTML = "";

          if (!products || products.length === 0) {
            container.innerHTML =
              '<p class="text-slate-400 text-sm">لا يوجد منتجات بعد.</p>';
            return;
          }

          products.forEach((p) => {
            const div = document.createElement("div");
            div.className =
              "flex items-center justify-between bg-slate-700 rounded-xl px-4 py-3 text-sm";
            div.innerHTML = `
              <div>
                <div class="font-semibold">${p.name}</div>
                <div class="text-slate-300">
                  ${p.price} ر.س - ${p.category || ""}
                </div>
              </div>
              <div class="text-xs text-slate-400">
                ID: ${p.id}
              </div>
            `;
            container.appendChild(div);
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function loadUsers() {
        const container = document.getElementById("usersList");
        if (!container) return;

        try {
          const res = await fetch(`${API_BASE}/api/users`);
          const users = await res.json();

          container.innerHTML = "";

          if (!users || users.length === 0) {
            container.innerHTML =
              '<p class="text-slate-400 text-sm">لا يوجد مستخدمون بعد.</p>';
            return;
          }

          users.forEach((u) => {
            const row = document.createElement("div");
            row.className =
              "flex items-center justify-between bg-slate-700 rounded-xl px-4 py-2";
            row.innerHTML = `
              <div>
                <div class="font-semibold">${u.name}</div>
                <div class="text-slate-300">${u.email}</div>
              </div>
              <div class="text-xs text-slate-400">
                ID: ${u.id} | Role: ${u.role}
              </div>
            `;
            container.appendChild(row);
          });
        } catch (err) {
          console.error(err);
        }
      }

      function setupAddProductForm() {
        const form = document.getElementById("addProductForm");
        const msg = document.getElementById("formMsg");
        if (!form) return;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "";
          msg.className = "text-sm";

          const formData = new FormData(form);
          const body = {
            name: formData.get("name"),
            price: formData.get("price"),
            category: formData.get("category"),
            image: formData.get("image"),
            description: formData.get("description"),
          };

          try {
            const res = await fetch(`${API_BASE}/api/products`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });

            const data = await res.json();

            if (!res.ok || !data.success) {
              msg.textContent = data.message || "حدث خطأ أثناء إضافة المنتج";
              msg.className = "text-sm text-rose-400";
              return;
            }

            msg.textContent = "تمت إضافة المنتج بنجاح ✅";
            msg.className = "text-sm text-emerald-400";
            form.reset();
            loadProducts();
          } catch (err) {
            console.error(err);
            msg.textContent = "خطأ في الاتصال بالسيرفر";
            msg.className = "text-sm text-rose-400";
          }
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const user = requireAdmin();
        if (!user) return;

        setupHeader(user);
        setupAddProductForm();
        loadProducts();
        loadUsers();
      });
    </script>
  </body>
</html>